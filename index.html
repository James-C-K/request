<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客訴與需求申請表單</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f3f4f6; }
        .required::after { content: " *"; color: red; }
        input[type="radio"]:checked + span { font-weight: bold; color: #2563eb; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="max-w-3xl mx-auto my-10 bg-white p-8 rounded-lg shadow-md min-h-[600px]">
    
    <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">
        {{ isSubmitted ? '案件已成功送出' : '內部客訴與需求申請表' }}
    </h1>

    <div v-if="!isSubmitted">
        <form @submit.prevent="submitForm" class="space-y-6">
            
            <div>
                <label class="block font-medium mb-1 required">Email</label>
                <input type="email" v-model="form.email" required class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block font-medium mb-1 required">你的單位</label>
                <select v-model="form.department" required class="w-full border rounded p-2 bg-white">
                    <option value="" disabled>請選擇</option>
                    <option>業務部門</option>
                    <option>業務經辦</option>
                    <option>客服部門</option>
                    <option>總務部門</option>
                    <option>會計部門</option>
                    <option>產品維運</option>
                    <option>產品研發</option>
                </select>
            </div>

            <div>
                <label class="block font-medium mb-2 required">類型 (單選)</label>
                <div class="flex space-x-6">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" value="客訴" v-model="form.requestType" class="mr-2 w-4 h-4">
                        <span>客訴</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" value="需求" v-model="form.requestType" class="mr-2 w-4 h-4">
                        <span>需求</span>
                    </label>
                </div>
            </div>

            <div class="p-5 bg-gray-50 rounded border border-gray-200">
                <label class="block font-medium mb-2 required">提出類型分類</label>
                <select v-model="form.category" @change="resetSubFields" required class="w-full border rounded p-2 bg-white mb-4">
                    <option value="" disabled>請選擇分類</option>
                    <optgroup label="師資教學">
                        <option value="業師總監">業師總監</option>
                    </optgroup>
                    <optgroup label="學生學習">
                        <option value="新生導覽">新生導覽</option>
                        <option value="學生專案">學生專案</option>
                        <option value="學生接案">學生接案</option>
                    </optgroup>
                    <optgroup label="產品行政">
                        <option value="學習助教">學習助教</option>
                        <option value="學習教練">學習教練</option>
                        <option value="業務資料">業務資料</option>
                        <option value="銷售方案">銷售方案</option>
                        <option value="產品設計">產品設計</option>
                        <option value="系統問題">系統問題</option>
                        <option value="線上課程">線上課程</option>
                        <option value="實體課程">實體課程</option>
                    </optgroup>
                </select>

                <div class="mt-4 border-t pt-4">
                    <label class="block font-medium mb-2 required">所屬品牌 (單選)</label>
                    <div class="grid grid-cols-3 gap-3">
                        <label v-for="brand in ['學米', '無限', '職能', '財經', 'XLAB', 'X Platform']" :key="brand" 
                               class="flex items-center cursor-pointer p-2 border rounded hover:bg-blue-50 transition bg-white">
                            <input type="radio" :value="brand" v-model="form.selectedBrand" class="mr-2 w-4 h-4 text-blue-600">
                            <span>{{ brand }}</span>
                        </label>
                    </div>
                </div>

                <div v-if="form.category === '業師總監'" class="mt-4">
                    <label class="block text-sm font-medium mb-1 required text-blue-800">老師姓名</label>
                    <input type="text" v-model="form.extraName" required class="w-full border rounded p-2 border-blue-200">
                </div>

                <div v-if="['新生導覽', '學生專案', '學生接案'].includes(form.category)" class="mt-4">
                    <label class="block text-sm font-medium mb-1 required text-blue-800">學生姓名</label>
                    <input type="text" v-model="form.extraName" required class="w-full border rounded p-2 border-blue-200">
                </div>

                <div v-if="form.category === '線上課程'" class="mt-4">
                    <label class="block text-sm font-medium mb-1 required text-blue-800">詳細問題分類</label>
                    <select v-model="form.subIssue" required class="w-full border rounded p-2 border-blue-200">
                        <option value="" disabled>請選擇</option>
                        <option value="教材問題">教材問題</option>
                        <option value="字幕問題">字幕問題</option>
                        <option value="影片問題">影片問題</option>
                        <option value="系統問題">系統問題</option>
                    </select>
                </div>

                <div v-if="form.category === '實體課程'" class="mt-4">
                    <label class="block text-sm font-medium mb-1 required text-blue-800">詳細問題分類</label>
                    <select v-model="form.subIssue" required class="w-full border rounded p-2 border-blue-200">
                        <option value="" disabled>請選擇</option>
                        <option value="教材問題">教材問題</option>
                        <option value="影片問題">影片問題</option>
                        <option value="系統問題">系統問題</option>
                        <option value="課程問題">課程問題</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block font-medium mb-1">CRM (簡述) - URL</label>
                <input type="url" v-model="form.crmLink" placeholder="請輸入網址 (例如: https://...)" class="w-full border rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <label class="block font-medium mb-1 required">詳述你的問題</label>
                <textarea v-model="form.description" rows="4" required class="w-full border rounded p-2"></textarea>
            </div>

            <div>
                <label class="block font-medium mb-1">上傳檔案 (可多選)</label>
                <input type="file" multiple @change="handleFileUpload" class="block w-full text-sm text-gray-500
                  file:mr-4 file:py-2 file:px-4
                  file:rounded-full file:border-0
                  file:text-sm file:font-semibold
                  file:bg-blue-50 file:text-blue-700
                  hover:file:bg-blue-100">
                <p v-if="form.files.length > 0" class="mt-1 text-sm text-green-600">
                    已選擇 {{ form.files.length }} 個檔案
                </p>
            </div>

            <button type="submit" :disabled="isSubmitting" 
                class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition disabled:bg-gray-400">
                {{ isSubmitting ? '資料傳送中...' : '送出表單' }}
            </button>
        </form>
    </div>

    <div v-else class="text-center py-8 fade-in">
        <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-6">
            <svg class="h-10 w-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        
        <h2 class="text-xl font-semibold text-gray-900 mb-2">資料已成功提交！</h2>
        
        <div v-if="responseCaseId" class="mb-6">
            <span class="bg-yellow-100 text-yellow-800 text-lg font-bold px-4 py-2 rounded-lg border border-yellow-200">
                案件編號：{{ responseCaseId }}
            </span>
        </div>

        <p class="text-gray-500 mb-8">以下是您剛剛送出的內容備份：</p>

        <div class="bg-gray-50 rounded-lg p-6 text-left space-y-3 text-sm border border-gray-200 mb-8">
            <div class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">Email</span>
                <span class="col-span-2 text-gray-800 break-all">{{ form.email }}</span>
            </div>
            <div class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">單位</span>
                <span class="col-span-2 text-gray-800">{{ form.department }}</span>
            </div>
            <div class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">類型</span>
                <span class="col-span-2 text-gray-800">{{ form.requestType }}</span>
            </div>
            <div class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">分類</span>
                <span class="col-span-2 text-gray-800">{{ form.selectedBrand }} - {{ form.category }}</span>
            </div>
            
            <div v-if="form.extraName" class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">相關姓名</span>
                <span class="col-span-2 text-gray-800">{{ form.extraName }}</span>
            </div>
            
            <div v-if="form.subIssue" class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">詳細問題</span>
                <span class="col-span-2 text-gray-800">{{ form.subIssue }}</span>
            </div>

            <div v-if="form.crmLink" class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">CRM 連結</span>
                <a :href="form.crmLink" target="_blank" class="col-span-2 text-blue-600 underline truncate">{{ form.crmLink }}</a>
            </div>

            <div class="grid grid-cols-3 border-b border-gray-200 pb-2">
                <span class="font-bold text-gray-500">問題詳述</span>
                <span class="col-span-2 text-gray-800 whitespace-pre-wrap">{{ form.description }}</span>
            </div>

            <div class="grid grid-cols-3">
                <span class="font-bold text-gray-500">上傳檔案</span>
                <span class="col-span-2 text-gray-800">
                    <span v-if="form.files.length === 0">無</span>
                    <ul v-else class="list-disc pl-4">
                        <li v-for="file in form.files" :key="file.name">{{ file.name }}</li>
                    </ul>
                </span>
            </div>
        </div>

        <button @click="resetForm" 
            class="w-full bg-white border border-blue-600 text-blue-600 font-bold py-3 rounded hover:bg-blue-50 transition">
            再次填寫
        </button>
    </div>

</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                isSubmitting: false,
                isSubmitted: false,
                responseCaseId: '', // 儲存後端回傳的案件編號
                form: {
                    email: '',
                    department: '',
                    requestType: '',    
                    category: '',
                    selectedBrand: '',  
                    extraName: '',      
                    subIssue: '',       
                    crmLink: '',        
                    description: '',
                    files: []           
                }
            }
        },
        methods: {
            resetSubFields() {
                this.form.extraName = '';
                this.form.subIssue = '';
            },
            handleFileUpload(event) {
                this.form.files = Array.from(event.target.files);
            },
            resetForm() {
                this.form = {
                    email: '',
                    department: '',
                    requestType: '',
                    category: '',
                    selectedBrand: '',
                    extraName: '',
                    subIssue: '',
                    crmLink: '',
                    description: '',
                    files: []
                };
                this.isSubmitted = false;
                this.responseCaseId = ''; // 清空編號
                window.scrollTo({ top: 0, behavior: 'smooth' });
            },
            async submitForm() {
                if (!this.form.selectedBrand) {
                    alert('請選擇「所屬品牌」');
                    return;
                }

                this.isSubmitting = true;

                const formData = new FormData();
                formData.append('email', this.form.email);
                formData.append('department', this.form.department);
                formData.append('requestType', this.form.requestType);
                formData.append('category', this.form.category);
                formData.append('selectedBrand', this.form.selectedBrand);
                formData.append('extraName', this.form.extraName);
                formData.append('subIssue', this.form.subIssue);
                formData.append('crmLink', this.form.crmLink); 
                formData.append('description', this.form.description);
                
                if (this.form.files.length > 0) {
                    this.form.files.forEach((file) => {
                        formData.append('files', file); 
                    });
                }

                const N8N_WEBHOOK_URL = 'https://ooschoolall.zeabur.app/webhook/submit-form'; 

                try {
                    const response = await fetch(N8N_WEBHOOK_URL, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        // === 這裡修改了：解析回傳的 JSON 並取出 caseId ===
                        const responseData = await response.json();
                        
                        // 嘗試從回傳資料中找到 caseId (n8n 可能回傳陣列或物件)
                        if (responseData.caseId) {
                            this.responseCaseId = responseData.caseId;
                        } else if (Array.isArray(responseData) && responseData[0] && responseData[0].caseId) {
                            this.responseCaseId = responseData[0].caseId;
                        } else {
                             // 若真的沒抓到，至少顯示一個提示
                             this.responseCaseId = '已生成 (請查看郵件)';
                        }

                        this.isSubmitted = true;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else {
                        alert('送出失敗，請稍後再試。');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('發生錯誤，請檢查網路連線。');
                } finally {
                    this.isSubmitting = false;
                }
            }
        }
    }).mount('#app');
</script>

</body>
</html>
